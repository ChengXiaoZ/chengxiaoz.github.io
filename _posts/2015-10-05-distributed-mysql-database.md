---
layout: post
title:  "Spider数据引擎实践与优化（一）MySQL/MaiaDB分布式数据库"
date:   2015-10-05
categories: Spider数据引擎实践与优化
---

* content
{:toc}

## 背景

电子商务、社交网络、电信、金融等领域数据处理需求的快速增长，使得数据存储、管理和分析面临着极大的挑战。依据数据操作的读写特点以及简单复杂特性，可对数据应用进行归类。[1]

![data-application]({{ "/css/pics/data-application.png"}})

*  操作型应用特点是写密集、操作简单。

*  分析型应用特点是读密集、操作复杂。

*  交互型应用介于两者之间，例如社交网络应用中大多数涉及简单操作，同时读操作与写操作相对平衡。  

不同应用类型中数据处理特点存在差异，单一依靠传统的关系数库，无法满足大规模海量数据的处理需求。
目前，构建大数据处理平台时，针对数据应用的特点，综合使用多种数据处理系统。对于复杂操作应用，普遍使用Hadoop和Spark。对于简单操作应用，可以使用Key/Value、文档、宽表NoSQL和分布式数据库。由于分布式数据库具有SQL和ACID的特点，其依然具有重要的地位。

---

## 分布式数据库

多处理器数据库系统的体系结构可分为[2]：

*  shared-memroy(sm)：由单一节点构成，多个cpu共享访问的内存和硬盘。

*  shared-disks(sd)：由多个节点构成，每个节点的cpu有私有的内存，所有节点共享访问一组硬盘。

*  shared-nothing(sn)：由多个节点构成，每个节点有私有的内存和硬盘。

sd和sn是普遍采用的分布式数据库结构。

*  从数据存储的角度看，sm和sd中数据只存储在一个节点，sn将数据划分到不同的节点，因此sm和sd的数据库设计和数据维护工作基本一致，而sn必须考虑数据的物理分布，工作具有很大挑战。当系统负载不高，2-4个节点能够满足系统负载的情况下，建议将sm迁移到sd，既提高了系统的性能和可用性，又不大幅增加应用开发和数据维护的工作量。Oracle的RAC是普遍使用的sd分布式数据库。


*  从可扩展性角度看，与sn只在网络中传递请求和结果相比，sd需要将数据块从硬盘传递到计算节点并且计算节点间要共享封锁信息，这导致当增加更多节点时，对网络带宽的竞争会加剧，系统整体性能会快速下降，因此sn比sd具有更好的扩展性。在系统具有极高负载，sm和sd无法支撑的情况下，不得不采用sn，需要认识到数据划分、跨节点的查询优化和事务处理，会给数据库设计和维护工作带来很大的挑战。


---

## MySQL分布式方案

MySQL数据库是广泛使用的数据库之一。通过在MySQL单一实例上，增加代理软件（分布式处理模块），发展出多个share nothing架构的分布式数据库方案。

这些方案部署结构基本相同，包括代理节点、数据节点和管理节点。数据按照hash或范围规则分布在多个数据节点，代理节点将用户请求发送到数据所在节点，数据节点执行操作请求，将结果返回给代理节点，代理节点对结果处理后，最终返回给用户。为保证数据可靠性，一份数据可以存储在多个数据节点，通过同步机制实现数据的一致。

依据代理软件在MySQL体系结构中所处的位置，以及与MySQL源码的关系，分布式数据库方案可以分为外部代理、代理引擎和数据引擎三种类型。

|										| 外部代理方案			|	代理引擎方案				| 数据引擎方案  |
|:------------------|:------------------|:--------------------|:--------------|
| 语法解析  				| 自行开发    			| 采用MySQL代码      	| 采用MySQL代码 |
| 分布式优化与执行 	| 自行开发  				| 基于MySQL代码扩充  	| 自行开发      |
| 跨数据节点事务 		| 自行开发  				| 基于MySQL代码扩充  	| 自行开发      |
| 数据同步 					| 采用MySQL的Binlog	| 采用MySQL的Binlog  	| 自行开发      |
| 数据节点 					| 采用MySQL数据引擎 | 采用MySQL数据引擎  	| 自行开发      |

*  外部代理方案：代理软件独立于MySQL源码开发，自行实现语法解析、分布式优化与执行、2PC事务等功能。数据节点和数据同步采用MySQL的数据引擎和Binlog。目前的软件有oracle的mysql proxy，阿里的cobar、amoeba、tddl、rds，360的atlas，以及mycat。

*  MySQL体系结构包含Server层（查询引擎）和数据引擎两个部分，数据引擎是可扩展的，通过实现handler接口，可以增加新的数据引擎。代理引擎方案和数据引擎方案中代理软件都是MySQL的数据引擎。

*  代理引擎方案：代理软件是一个MySQL数据引擎，但自身不提供数据的存储，而是提供对远程数据表的访问。使用MySQL的Server层完成语法解析；基于MySQL代码，扩充实现分布式优化与执行和跨节点事务。数据节点和数据同步采用MySQL的数据引擎和Binlog。目前的软件有：Spider存储引擎和FedX存储引擎（不提供数据分片）。

*  数据引擎方案：代理软件是一个MySQL数据引擎，使用MySQL查询引擎作为查询接口，其它的功能都是由引擎自行开发。目前软件有：NDB存储引擎、dbscale存储引擎（share disc结构）。

---

## 方案对比

*  NDB存储引擎没有被广泛使用，可能是两个原因：1、单节点MySQL方案普遍采用innodb引擎，如果转换到NDB引擎，数据格式会发生变化，这给系统维护带来较大的工作量。2、NDB的单节点性能不如innodb引擎，同时当节点增加到十几个节点后，系统存在瓶颈。

*  外部代理和引擎代理两个方案的原理与功能类似，都采用MySQL自身数据引擎（主要是innodb）和Binlog同步机制。两者的差别在于代理软件是独立开发，还是基于MySQL源代码开发。

	*  从开发工作量上看，代理引擎方案可以充分利用MySQL已有代码，而外部代理方案需要自行开发，工作量大。

	*  从软件结构上看，外部代理只关注分布式处理，软件独立开发，软件结构模块清晰，模块化好，而代理引擎方案是在MySQL已有的结构中，增加分布式处理模块。

	*  由于MySQL Server层源码模块耦合度较高，代码阅读理解难度较大。如何合理的增加分布式处理模块，是此方案的难点。
	
	*	 Postgre的分布式处理方案Postgre-XC也是基于Postgre代码开发，与代理引擎的原理相同。

*  目前国内主要采用corba、tddle等外部代理的方案，Spider引擎的方案在腾讯游戏有应用。

## 目的

两年前，在一个分布式数据库项目中，我们选择了Spider引擎的技术方案。通过使用、测试、改造与优化，感到Spider虽然其存在不少问题，但仍然是一个有价值的技术方案。后续，我们将陆续介绍应用Spider的经验，供大家交流与讨论。

## 参考资料
[1]Michael Stonebraker and Rick Cattell. Ten Rules for Scalable Performance in “Simple Operation” Datastores.

[2]Michael Stonebraker. The Case for Shared Nothing. 

---
本文内容遵从CC版权协议, 可以随意转载, 但必须以超链接形式标明文章原始出处和作者信息及版权声明  
